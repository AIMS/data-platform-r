---
title: "AIMS weather time series data sets"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{AIMS weather time series data sets}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

Please check our [intro vignette][1] first to implement the installation
requirements, and to learn the general approach to navigating the different
datasets. This vignette assumes you have obtained an
[AIMS Data Platform API Key][2].

[1]: https://open-aims.github.io/dataaimsr/articles
[2]: https://open-aims.github.io/data-platform/key-request

Let's start by loading some packages that we are going to need down the track,
and store the API key as an object---if you successfully placed your API Key
permanently to the `.Renviron`, then just set the object `my_api_key` to `NULL`
in the chunk below:

```{r, eval = FALSE}
library(plyr)
library(tidyverse)
library(dataaimsr)
# set my_api_key to NULL if successfully placed in .Renviron
# paste your key where it says api-key-for-r-notebook
my_api_key <- "api-key-for-r-notebook"
```


```{r, echo = FALSE, message = FALSE, warning = FALSE}
library(plyr)
library(tidyvers)
library(dataaimsr)
my_api_key <- "x78NRh0XrH9Irtju5OoOdTYBhG0pklw2w6o7eos6"
```

## Discover a dataset

Suppose we want to query a data series and plot it then the procedure might be:

1. Examine documentation and establish query filters
2. Perform data download using `aims_data`
3. Use the Rpackage `ggplot2` to create a time-series chart

To explore the [AIMS Weather](https://doi.org/10.25845/5c09bf93f315d) dataset,
we use the function `filter_values`. This function takes a DOI and a given
parameter filter, and returns all the available information regarding the filter.
For all data sets, a list of available filter parameters can be found with the
function `expose_attributes`. We recommend exploring the parameter `series`:

```{r}
weather_doi <- aims_data_doi("weather")
filter_values(weather_doi, filter_name = "series") %>%
  head()
expose_attributes(weather_doi)  
```

The benefits to choosing a data `series` is that it comes from one location
and parameter type, making the data easy to plot. If we did not choose a
data series from the [AIMS Weather](https://doi.org/10.25845/5c09bf93f315d)
dataset, we would have to specify additional parameters to ensure the data
is downloaded as expected.

Finally our values and filters might look like the following:

Variable  | Value                  | Description
----------|------------------------|-------------------------------------------------------
doi       | 10.25845/5c09bf93f315d | DOI for AIMS Weather found [here](https://open-aims.github.io/data-platform)
series    | 64                     | Found [here](https://apps.aims.gov.au/metadata/view/5fc91100-4ade-11dc-8f56-00008a07204e), Davies Reef Air Temperature data series
from-date | '2018-01-01'           | We want to start charting on 1/1/2018
thru-date | '2018-01-10'           | We are plotting 10 days of data

## Query and Plot Dataset

After deciding on query parameters, we plug the series id into a `aims_data` function:

```{r, message = FALSE, warning = FALSE}
davies <- aims_data(weather_doi,
                    api_key = my_api_key,
                    filters = list("series" = 64,
                                   "from-date" = "2018-01-01",
                                   "thru-date" = "2018-01-10"))
```

We can even visually compare multiple series at once. For instance, let's
compare the air temperature data from Davies Reef and Bramble Cay for the
same period of time:

```{r, message = FALSE, warning = FALSE, fig.width = 5, fig.height = 5}
target_series <- c("Davies Reef" = 64, "Bramble Cay" = 87929)
results <- plyr::llply(target_series, function(series_number, my_api_key, ...) {
  aims_data(weather_doi, api_key = my_api_key, 
            filters = list("series" = series_number, ...))
}, my_api_key = my_api_key, "from-date" = "2018-01-01", "thru-date" = "2018-01-10")

weather_data <- plyr::ldply(results, "[[", "data")

ggplot(data = weather_data) +
  geom_line(mapping = aes(x = time, y = raw_value,
                          colour = site_name)) +
  labs(x = "Date",
       y = "Air temperature (˚C)",
       colour = "Site",
       title = "AIMS",
       subtitle = "Weather stations") +
  theme_bw() +
  theme(axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        legend.position = "bottom")
```

One could also download data for a particular time of day throughout
the year, e.g. for Heron Island Relay Pole 8 at 5.4 m of depth (series
10394):

```{r, message = FALSE, warning = FALSE, fig.width = 5, fig.height = 5}
days <- seq(as.Date("2018-01-01"), as.Date("2018-12-31"), by = "day")
out <- numeric(length = length(days))
for (i in seq_along(days)) {
  hour_in <- paste0(days[i], "T06:00:00")
  hour_out <- paste0(days[i], "T12:00:00")
  df <- aims_data(weather_doi,
                  api_key = my_api_key,
                  filters = list("series" = 10394,
                                 "from-date" = hour_in,
                                 "thru-date" = hour_out))$data
  out[i] <- mean(df$raw_value)
}

data.frame(date = days,
           temps = out) %>%
  ggplot(data = .) +
    geom_line(mapping = aes(x = date, y = temps)) +
    labs(x = "Date",
         y = "Air temperature (˚C)",
         title = "Heron Island (2018)",
         subtitle = "mean 6 A.M. – 12 P.M.") +
    theme_bw() +
    theme(axis.title.x = element_text(size = 12),
          axis.title.y = element_text(size = 12),
          legend.position = "bottom")
```

## Bibliography

```{r, message = FALSE, warning = FALSE}
plyr::ldply(results, "[[", "citation") %>%
  dplyr::rename("citation" = "[[") %>%
  dplyr::select(citation) %>%
  unlist %>%
  unname
```
