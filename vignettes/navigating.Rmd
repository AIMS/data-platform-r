---
title: "Navigating dataaimsr"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Navigating dataaimsr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Discover a dataset

The very first thing to do is read the documentation on our
[README](../index.html) page. Make sure you have the package properly 
installed, and that your personal [AIMS Data Platform API Key][1] has 
been downloaded.

[1]: https://open-aims.github.io/data-platform/key-request

Once you have obtained your API Key, you can either place it 
permanently on your `.Renviron` file and set the object `my_api_key` to 
`NULL` in the chunk below, or if for some reason you are having 
difficulty placing your API Key permanently to the `.Renviron`, then 
just paste it to the object `my_api_key` below.

```{r, echo = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(ggmap)
library(dataaimsr)
my_api_key <- "x78NRh0XrH9Irtju5OoOdTYBhG0pklw2w6o7eos6"
```

```{r, eval = FALSE}
# set my_api_key to NULL if successfully placed in .Renviron
# paste your key where it says api-key-for-r-notebook
my_api_key <- "api-key-for-r-notebook"
```

Then install `dataaimsr` following the documentation on our
[README](../index.html) page. Once that's out of the way, we load the packages needed for this vignette:

```{r, eval = FALSE}
library(tidyverse)
library(ggmap)
library(dataaimsr)
```

## How this package works

`dataaimsr` contains two sets of monitoring data collected by AIMS
since the 1980's: the [Weather Station][2] dataset which contains 
encompasses data for different parameters (e.g. Air Temperature, Air 
Pressure, Chlorophyll, and many others); and the
[Sea Water Temperature Loggers][3] dataset which contains records of 
(you guessed it!) sea water temperature at different sites and water 
depths.

[2]: https://doi.org/10.25845/5c09bf93f315d
[3]: https://doi.org/10.25845/5b4eb0f9bb848

The datasets are very large, and as such they are not locally stored.
They are instead downloaded via the API and unique DOI identifier (just 
hover over the data links above to see the actual DOI codes). The 
datasets are structured by sites, series and parameters. A series is a 
continuing time-series, i.e. a collection of deployments measuring the 
same parameter (e.g. Air Temperature, Air Pressure, Chlorophyll) at the 
same site.

For the Sea Water Temperature Loggers dataset, series is synonymous 
with the variable called subsite. For the Weather Station dataset, it 
is the combination of subsite and parameter.

This vignette gives an overview of how one would go about discovering
the overall information contained in the datasets. For dataset-specific 
vignettes, see our other [vignette pages][4].

[4]: https://open-aims.github.io/dataaimsr/articles

## Discover a dataset

The [AIMS Data Platform API][5] points to the full metadata of each
dataset. We are currently working on ways to facilitate the 
visualisation of both datasets and their multiple features directly
through the R package.


[5]: https://open-aims.github.io/data-platform 

Suppose we want to query a data series and plot it then the procedure might be:

1. Examine documentation and establish query filters
2. Perform data download using `aims_data`
3. Use the Rpackage `ggplot2` to create a time-series chart


For the purposes of this example, we will query the [AIMS Weather](https://doi.org/10.25845/5c09bf93f315d). To explore this data program, we use the function `filter_values`. This function takes a DOI and a given parameter filter, and returns all the available information regarding the filter. For all data sets, a list of available filter parameters can be found with the function `expose_attributes`. We recommend exploring the parameter `series`:

```{r}
weather_doi <- aims_data_doi("weather")
filter_values(weather_doi, filter_name = "series") %>%
  head()
```

The benefits to choosing a data `series` is that it comes from one location and variable type, making the data easy to plot. If we did not choose a data series from the [AIMS Weather](https://doi.org/10.25845/5c09bf93f315d) program, we would have to specify additional parameters to ensure the data is as expected.

Finally our values and filters might look like the following:

Variable  | Value                  | Description
----------|------------------------|-------------------------------------------------------
doi       | 10.25845/5c09bf93f315d | DOI for AIMS Weather found [here](https://open-aims.github.io/data-platform)
series    | 64                     | Found [here](https://apps.aims.gov.au/metadata/view/5fc91100-4ade-11dc-8f56-00008a07204e), Davies Reef Air Temperature data series
from-date | '2018-01-01'           | We want to start charting on 1/1/2018
thru-date | '2018-01-10'           | We are plotting 10 days of data

## Query and Plot Dataset

After deciding on query parameters, we plug the series id into a `aims_data` function:

```{r, message = FALSE, warning = FALSE}
davies <- aims_data(weather_doi,
                    api_key = my_api_key,
                    filters = list("series" = 64,
                                   "from-date" = "2018-01-01",
                                   "thru-date" = "2018-01-10"))
```

The object `davies` is a list containing four elements:  
- `metadata` a doi link containing the metadata record for the data series  
- `citation` the citation information for the particular dataset 
- `links` the link returning the data query  
- `data` an output `data.frame`  

We can even visually compare multiple series at once. For instance, let's compare the air temperature data from Davies Reef and Bramble Cay for the same period of time:

```{r, message = FALSE, warning = FALSE, fig.width = 5, fig.height = 5}
target_series <- c("Davies Reef" = 64, "Bramble Cay" = 87929)
results <- plyr::llply(target_series, function(series_number, my_api_key, ...) {
  aims_data(weather_doi, api_key = my_api_key, 
            filters = list("series" = series_number, ...))
}, my_api_key = my_api_key, "from-date" = "2018-01-01", "thru-date" = "2018-01-10")

weather_data <- plyr::ldply(results, "[[", "data")

ggplot(weather_data) +
  geom_line(aes(x = time, y = raw_value, colour = site_name)) +
  labs(x = "Date",
       y = "Air temperature (ËšC)",
       colour = "Site",
       title = "AIMS",
       subtitle = "Weather stations") +
  theme_bw() +
  theme(axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        legend.position = "bottom")
```

## Bibliography

```{r, message = FALSE, warning = FALSE}
plyr::ldply(results, "[[", "citation") %>%
  dplyr::rename("citation" = "[[") %>%
  dplyr::select(citation) %>%
  unlist %>%
  unname
```
