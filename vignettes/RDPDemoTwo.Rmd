---
title: "RDP - Data Access via the API"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{RDP - Data Access via the API}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

#### This R Notebook demonstrates access to the Research Data Platform API using the R language


## 1. Register my API Key and Load the Libraries:

```{r message=FALSE, warning=FALSE}
MY_API_KEY <- "5xoN44VxEM5uQHxB0iydYijBwqbGCAO5DOyvA1t3"
library(dataaimsr)

library(plyr)
library(dplyr)
library(ggplot2)
library(tidyverse)
```


## 2. Find a Dataset:

### Each data set has a DOI, a list of DOI's can be found at:


> https://aims.github.io/data-platform
  
### The DOI for the weather stations is:

- 10.25845/5c09bf93f315d
  
### and for the LTMP Data the DOI is:

- e791fa0e-053b-4a50-b856-aaa0b88848d7
  
  
### We can see the sites available by:

```{r}
filter_values("e791fa0e-053b-4a50-b856-aaa0b88848d7", filter_name = "sites")
```


## 3. Get the Percentage Hard Coral data from the API service by Site

```{r message=FALSE, warning=FALSE}
Site1 <- aims_data("e791fa0e-053b-4a50-b856-aaa0b88848d7", filters = list("site"="Davies Reef Site 1", "from-date"="2007-01-01","thru-date"="2020-01-01"))

Site2 <- aims_data("e791fa0e-053b-4a50-b856-aaa0b88848d7", filters = list("site"="Davies Reef Site 2", "from-date"="2007-01-01","thru-date"="2020-01-01"))

Site3 <- aims_data("e791fa0e-053b-4a50-b856-aaa0b88848d7", filters = list("site"="Davies Reef Site 3", "from-date"="2007-01-01","thru-date"="2020-01-01"))

all_sites <- rbind(Site1, Site2, Site3)

head(all_sites, n=5L)
```

## 4 Convert the data to numbers and identify the transects

```{r}
all_sites <- transform(all_sites, hc_cover = as.numeric(hc_cover))
all_sites <- transform(all_sites, year = as.numeric(year))

all_sites$survey_title <- substr(all_sites$survey_title, 20, 29)
```


## 5. Plot the individual transects through time:

### Site 1:

```{r, fig.width = 12, fig.height = 6, message=FALSE, warning=FALSE}
site_1 <- all_sites %>% filter(site_name == "Davies Reef Site 1")

g1<-ggplot(site_1, aes(x = year, y = hc_cover)) + 
  geom_line(aes(color = survey_title), size = 1) +
  theme_minimal()

g1<-g1+labs(title='Hard Coral Cover for Davies Reef, Site 1.')

g1<-g1+theme(plot.title = element_text(size=20))
g1<-g1+scale_x_continuous(breaks=c(2007,2009,2011,2013,2015,2017,2019))
g1<-g1+scale_y_continuous(breaks=c(0.0,0.05,0.10,0.15,0.20,0.25,0.30,0.35,0.40,0.45,0.50,0.55,0.60,0.65))
g1<-g1+ylim(0.15,0.5)

g1
```


### Site 2:

```{r, fig.width = 12, fig.height = 6, message=FALSE, warning=FALSE}
site_2 <- all_sites %>% filter(site_name == "Davies Reef Site 2")

g2<-ggplot(site_2, aes(x = year, y = hc_cover)) + 
  geom_line(aes(color = survey_title), size = 1) +
  theme_minimal()

g2<-g2+labs(title='Hard Coral Cover for Davies Reef, Site 2.')

g2<-g2+theme(plot.title = element_text(size=20))
g2<-g2+scale_x_continuous(breaks=c(2007,2009,2011,2013,2015,2017,2019))
g2<-g2+scale_y_continuous(breaks=c(0.0,0.05,0.10,0.15,0.20,0.25,0.30,0.35,0.40,0.45,0.50,0.55,0.60,0.65))
g2<-g2+ylim(0.15,0.5)

g2
```


### Site 3:

```{r, fig.width = 12, fig.height = 6, message=FALSE, warning=FALSE}
site_3 <- all_sites %>% filter(site_name == "Davies Reef Site 3")

g3<-ggplot(site_3, aes(x = year, y = hc_cover)) + 
  geom_line(aes(color = survey_title), size = 1) +
  theme_minimal()
g3<-g3+labs(title='Hard Coral Cover for Davies Reef, Site 3.')

g3<-g3+theme(plot.title = element_text(size=20))
g3<-g3+scale_x_continuous(breaks=c(2007,2009,2011,2013,2015,2017,2019))
g3<-g3+scale_y_continuous(breaks=c(0.0,0.05,0.10,0.15,0.20,0.25,0.30,0.35,0.40,0.45,0.50,0.55,0.60,0.65))
g3<-g3+ylim(0.15,0.5)

g3
```


## 6. Now do the summary stats by Site and then by Reef:

### By Site:

```{r}
hcc_by_site <- aggregate(all_sites[, 9], list(all_sites$site_name, all_sites$year), mean, na.rm=TRUE)

names(hcc_by_site)[names(hcc_by_site) == "Group.1"] <- "Site"
names(hcc_by_site)[names(hcc_by_site) == "Group.2"] <- "Year"
names(hcc_by_site)[names(hcc_by_site) == "x"] <- "HC_Cover"

hcc_by_site
```

```{r, fig.width = 12, fig.height = 6, message=FALSE, warning=FALSE}
g4<-ggplot(hcc_by_site, aes(x = Year, y = HC_Cover)) + 
  geom_line(aes(color = Site), size = 1) +
  theme_minimal()
g4<-g4+labs(title='Hard Coral Cover for Davies Reef by Site.')

g4<-g4+theme(plot.title = element_text(size=20))
g4<-g4+scale_x_continuous(breaks=c(2007,2009,2011,2013,2015,2017,2019))
g4<-g4+scale_y_continuous(breaks=c(0.0,0.05,0.10,0.15,0.20,0.25,0.30,0.35,0.40,0.45,0.50,0.55,0.60,0.65))
g4<-g4+ylim(0.15,0.5)

g4
```

### By Reef:

```{r}

hcc_by_year <- aggregate(all_sites[, 9], list(all_sites$year), mean, na.rm=TRUE)

names(hcc_by_year)[names(hcc_by_year) == "Group.1"] <- "Year"
names(hcc_by_year)[names(hcc_by_year) == "x"] <- "HC_Cover"

hcc_by_year
```

```{r, fig.width = 12, fig.height = 6, message=FALSE, warning=FALSE}
g5<-ggplot(hcc_by_year, aes(x = Year, y = HC_Cover)) + 
  geom_line(size = 1) +
  theme_minimal()

g5<-g5+labs(title='Hard Coral Cover for Davies Reef')

g5<-g5+theme(plot.title = element_text(size=20))
g5<-g5+scale_x_continuous(breaks=c(2007,2009,2011,2013,2015,2017,2019))
g5<-g5+scale_y_continuous(breaks=c(0.0,0.05,0.10,0.15,0.20,0.25,0.30,0.35,0.40,0.45,0.50,0.55,0.60,0.65))
g5<-g5+ylim(0.15,0.5)

g5
```

